# Server Backend for Chat App

Chat App backend uses Fluvio to real-time data streaming and persistency.
For more information checkout [fluvio](https://fluvio.io).

## Fluvio Topics

Fluvio stores messages/events in three different topics:
* **chat-app-users**
* **chat-app-sessions**
* **chat-app-messages**

Chat app uses these events for persistence, however these messages are available to any number of consumers. For example if another service needs be triggered on login, the service can hook-up a consumer and receive login events in real-time.

### User Events

User events are generated by registration, login, and logout:

* **AddUser** - generated by registration.
* **AddToken** - generated by login.
* **RemoveToken** - generated by logout.
* **RemoveUser** - generated by unregistration.

When a user registers, the server assigns him a color code; when he logs-in, the server sends an authorization tokens.

User messages can be viewed in Fluvio:

```bash
fluvio consume chat-app-users -B
```

Returns all messages in the topic:

```json
{"kind":"AddUser","content":{"user":"alice","colorCode":"lime"}}
{"kind":"AddToken","content":{"user":"alice","token":"7b0164dbde7c92a0d9d9cf9eafe7e4a63ce0bb3c"}}
{"kind":"AddUser","content":{"user":"bob","colorCode":"purple"}}
{"kind":"AddToken","content":{"user":"bob","token":"0737d893bc368fb8e02a88bd1479287b75dc7082"}}
{"kind":"RemoveToken","content":{"user":"jack","token":"03d492c63e44c3c61829dffb89e19cf5b34432df"}}
```

### Session Events

Chat App supports multiple sessions for the same user. For instance the user may login at the same time from a web server and a mobile device. User sessions capture the beginning of the session and the online/offline state.

A user is marked online when it is connected on at least one device and offline when it is disconnected from all devices.

Session messages can be viewed in Fluvio:

```bash
fluvio consume chat-app-sessions -B
```

Returns all messages in the topic:

```json
{"kind":"Started","content":{"user":"alice","sid":"c41e59f83f713fdcf25affabf458a594"}}
{"kind":"UserOnline","content":{"user":"alice"}}
{"kind":"Started","content":{"user":"bob","sid":"6a9a7ec4831e8291f78aec8c6e2b738c"}}
{"kind":"UserOnline","content":{"user":"bob"}}
{"kind":"Started","content":{"user":"charlie","sid":"5d4973b4bf39e182020174daecca1459"}}
{"kind":"UserOnline","content":{"user":"charlie"}}
```

### Chat Messages

Chat messages store all user messages published by all users.

```bash
fluvio consume chat-app-messages -B
```

Returns all messages in the topic:

```json
{"sid":"5d4973b4bf39e182020174daecca1459","message":{"user":"charlie","message":"Hey guys","timestamp":"2021-01-01T11:04:16.792"}}
{"sid":"c41e59f83f713fdcf25affabf458a594","message":{"user":"alice","message":"What's going on charlie?","timestamp":"2021-01-01T11:04:40.161"}}
{"sid":"c41e59f83f713fdcf25affabf458a594","message":{"user":"alice","message":"Not much. Just pretty excited about using fluvio!","timestamp":"2021-01-01T11:05:15.755"}}
```
